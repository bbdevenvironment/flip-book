const express = require('express');
const multer = require('multer');
const cors = require('cors');
const path = require('path');
// const fs = require('fs'); // <--- Removed: Not reliable in serverless environment

const app = express();
const PORT = process.env.PORT || 5000;

// ********************************************
// FIX: Use memoryStorage for serverless functions
// ********************************************
const storage = multer.memoryStorage();
const upload = multer({Â 
    storage: storage,
    fileFilter: (req, file, cb) => {
        console.log(`Received file: ${file.originalname}, type: ${file.mimetype}`);
        if (file.mimetype !== 'application/pdf') {
            console.log('Rejected: Not a PDF file');
            return cb(new Error('Only PDF files are allowed!'), false);
        }
        cb(null, true);
    },
    limits: {
        fileSize: 50 * 1024 * 1024 // 50MB limit
    }
});
// ********************************************

// Define upload directory (Keep for path logic, but actual writes are removed)
// const UPLOAD_DIR = path.join(__dirname, 'uploads');
// if (!fs.existsSync(UPLOAD_DIR)) {
//     fs.mkdirSync(UPLOAD_DIR, { recursive: true });
//     console.log(`Created upload directory: ${UPLOAD_DIR}`);
// }

// Configure CORS
const corsOptions = {
Â  origin: [
Â  Â  'https://flip-book-frontend.vercel.app',
Â  Â  'http://localhost:5173',
Â  Â  'http://localhost:3000'
Â  ],
Â  credentials: true,
Â  methods: ['GET', 'POST', 'OPTIONS']
};

app.use(cors(corsOptions));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ********************************************
// Removed: Serving uploaded files publicly - needs external storage (e.g., S3)
// app.use('/public', express.static(UPLOAD_DIR, ...));
// ********************************************

// Log all requests
app.use((req, res, next) => {
    console.log(`${new Date().toISOString()} - ${req.method} ${req.url}`);
    next();
});

// Helper function to get base URL
const getBaseUrl = (req) => {
Â  Â  // For production environments (Vercel, Render, etc.)
Â  Â  if (process.env.VERCEL_URL) {
Â  Â  Â  Â  return `https://${process.env.VERCEL_URL}`;
Â  Â  }
Â  Â  // Fallback for development
Â  Â  const protocol = req.protocol;
Â  Â  const host = req.get('host');
Â  Â  return `${protocol}://${host}`;
};


// Health Check Endpoint
app.get('/api/health', (req, res) => {
Â  Â  const baseUrl = getBaseUrl(req);
Â  Â  res.json({Â 
Â  Â  Â  Â  status: 'OK',Â 
Â  Â  Â  Â  message: 'BookBuddy PDF Flipbook Server is running (Serverless Mode)',
Â  Â  Â  Â  timestamp: new Date().toISOString(),
Â  Â  Â  Â  baseUrl: baseUrl,
Â  Â  Â  Â  environment: process.env.NODE_ENV || 'development',
Â  Â  Â  Â  // Removed: uploadDir
Â  Â  Â  Â  endpoints: {
Â  Â  Â  Â  Â  Â  upload: `${baseUrl}/api/upload-pdf`,
Â  Â  Â  Â  Â  Â  // Removed: publicFiles
Â  Â  Â  Â  }
Â  Â  });
});

// Test Endpoint
app.get('/api/test', (req, res) => {
Â  Â  const baseUrl = getBaseUrl(req);
Â  Â  res.json({
Â  Â  Â  Â  message: 'BookBuddy Backend is operational',
Â  Â  Â  Â  serverTime: new Date().toISOString(),
Â  Â  Â  Â  baseUrl: baseUrl,
Â  Â  Â  Â  uploadEndpoint: `${baseUrl}/api/upload-pdf`,
Â  Â  Â  Â  // Removed: publicFilesUrl
Â  Â  Â  Â  // Removed: uploadDirectory, availableFiles
Â  Â  });
});

// Removed: List uploaded files endpoint

// File upload endpoint
app.post('/api/upload-pdf', (req, res) => {
    console.log('Upload request received');
    
    // Handle the upload
    upload.single('bookbuddy')(req, res, (err) => {
        if (err) {
            console.error('Upload error:', err);
            
            if (err instanceof multer.MulterError) {
                if (err.code === 'LIMIT_FILE_SIZE') {
                    return res.status(400).json({
                        success: false,
                        message: 'File size too large. Maximum size is 50MB.'
                    });
                }
                return res.status(400).json({
                    success: false,
                    message: `Upload error: ${err.message}`
                });
            }
            return res.status(400).json({
                success: false,
                message: err.message
            });
        }

        if (!req.file) {
            console.log('No file in request');
            return res.status(400).json({Â 
                success: false,Â 
                message: 'No PDF file uploaded. Make sure to use field name "bookbuddy" in FormData.'Â 
            });
        }

        // ********************************************
        // FIX: The following lines are MOCKED to simulate a successful cloud upload
        // In a real app, you would upload req.file.buffer to S3 here
        // The filename and public URL must be generated by the cloud service.
        // ********************************************
        const generatedFileName = `${path.parse(req.file.originalname).name.replace(/[^a-zA-Z0-9]/g, '-')}-${Date.now()}.pdf`;
        
        // This publicFileUrl must point to your *actual* cloud storage location (e.g., S3 URL)
        // I'm using the original Vercel URL structure as a placeholder.
        const baseUrl = getBaseUrl(req);
        const publicFileUrl = `${baseUrl}/public/${generatedFileName}`;
        // ********************************************

        console.log('File received in memory successfully:', {
            filename: generatedFileName,
            originalname: req.file.originalname,
            size: req.file.size,
            publicFileUrl: publicFileUrl
        });

        res.json({
            success: true,
            message: 'File uploaded successfully.',
            filename: generatedFileName,
            originalname: req.file.originalname,
            size: req.file.size,
            publicFileUrl: publicFileUrl,
            // downloadUrl: `${baseUrl}/api/download/${generatedFileName}`, // Removed download
            shareableUrl: `[FRONTEND_URL]/?file=${generatedFileName}` // Placeholder for frontend URL
        });
    });
});

// Removed: Download endpoint

// Root endpoint (Updated)
app.get('/', (req, res) => {
Â  Â  const baseUrl = getBaseUrl(req);
Â  Â  res.json({
Â  Â  Â  Â  message: 'BookBuddy PDF Flipbook API (Serverless)',
Â  Â  Â  Â  version: '1.1.0',
Â  Â  Â  Â  endpoints: {
Â  Â  Â  Â  Â  Â  upload: {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  url: '/api/upload-pdf',
Â  Â  Â  Â  Â  Â  Â  Â  fieldName: 'bookbuddy',
Â  Â  Â  Â  Â  Â  Â  Â  description: 'Upload a PDF file'
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  health: {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'GET',
Â  Â  Â  Â  Â  Â  Â  Â  url: '/api/health',
Â  Â  Â  Â  Â  Â  Â  Â  description: 'Server health check'
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  test: {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'GET',
Â  Â  Â  Â  Â  Â  Â  Â  url: '/api/test',
Â  Â  Â  Â  Â  Â  Â  Â  description: 'Test endpoint'
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  },
Â  Â  Â  Â  instructions: 'Switch to a persistent cloud storage solution (e.g., AWS S3) for production.'
Â  Â  });
});


// 404 Handler (Updated)
app.use((req, res) => {
Â  Â  const baseUrl = getBaseUrl(req);
Â  Â  res.status(404).json({
Â  Â  Â  Â  success: false,
Â  Â  Â  Â  message: 'Endpoint not found',
Â  Â  Â  Â  requestedUrl: req.url,
Â  Â  Â  Â  baseUrl: baseUrl,
Â  Â  Â  Â  availableEndpoints: [
Â  Â  Â  Â  Â  Â  'GET /',
Â  Â  Â  Â  Â  Â  'GET /api/health',
Â  Â  Â  Â  Â  Â  'GET /api/test',
Â  Â  Â  Â  Â  Â  'POST /api/upload-pdf',
Â  Â  Â  Â  ]
Â  Â  });
});

// Error Handling Middleware
app.use((err, req, res, next) => {
Â  Â  console.error('Server error:', err);
Â  Â  res.status(500).json({
Â  Â  Â  Â  success: false,
Â  Â  Â  Â  message: 'Internal server error',
Â  Â  Â  Â  error: process.env.NODE_ENV === 'development' ? err.message : undefined,
Â  Â  Â  Â  stack: process.env.NODE_ENV === 'development' ? err.stack : undefined
Â  Â  });
});

// Start Server (No changes needed for local start)
app.listen(PORT, () => {
Â  Â  console.log(`ğŸš€ Server running on port ${PORT}`);
Â  Â  console.log(`ğŸŒ Local URL: http://localhost:${PORT}`);
Â  Â  console.log(`ğŸ“¤ Upload endpoint: http://localhost:${PORT}/api/upload-pdf`);
});